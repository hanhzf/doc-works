## snat


SNAT（Source Network Address Translation，源地址网络地址转换）是 NAT 的一种，用于改变数据包的源 IP 地址。当内部网络中的数据包通过路由器或防火墙发送到外部网络时，SNAT 会将数据包的源 IP 地址替换为路由器或防火墙的公共 IP 地址。这样，响应数据包可以正确返回到内部网络的原始设备。

### SNAT 的工作原理

1. **源数据包发送**：内部设备（例如 192.168.1.10）发送数据包到外部设备（例如 8.8.8.8）。
2. **SNAT 处理**：路由器或防火墙将数据包的源 IP 地址从 192.168.1.10 替换为其公共 IP 地址（例如 203.0.113.1）。
3. **数据包传输**：数据包被发送到外部设备，源 IP 地址现在是 203.0.113.1。
4. **响应数据包**：外部设备（8.8.8.8）将响应数据包发送到 203.0.113.1。
5. **SNAT 回写**：路由器或防火墙接收到响应数据包，将目标 IP 地址从 203.0.113.1 替换回原始内部设备的 IP 地址（192.168.1.10）。
6. **数据包到达**：响应数据包返回到内部设备（192.168.1.10）。

### 连接跟踪表

为了确保响应数据包能够正确返回到内部设备，路由器或防火墙会维护一个连接跟踪表。该表记录了所有经过 SNAT 处理的数据包的原始 IP 地址和端口与转换后的 IP 地址和端口之间的映射关系。

### SNAT 实例

以下是一个使用 `iptables` 配置 SNAT 的具体示例：

假设你有一个内部网络（192.168.1.0/24），并且你的路由器的公共 IP 地址是 203.0.113.1。

#### 配置 SNAT 规则

```sh
iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -o eth0 -j SNAT --to-source 203.0.113.1
```

- `-t nat`：指定 NAT 表。
- `-A POSTROUTING`：在 POSTROUTING 链中追加规则。
- `-s 192.168.1.0/24`：源地址是 192.168.1.0/24 网络。
- `-o eth0`：出站接口是 eth0。
- `-j SNAT`：使用 SNAT 目标。
- `--to-source 203.0.113.1`：将源地址转换为 203.0.113.1。

### 数据包回流过程

1. **内部设备发送请求**：

内部设备 192.168.1.10 向 8.8.8.8 发送请求数据包。

```plaintext
源 IP：192.168.1.10 -> 目标 IP：8.8.8.8
```

2. **路由器进行 SNAT**：

路由器将源 IP 地址替换为 203.0.113.1，并将数据包发送到 8.8.8.8。

```plaintext
源 IP：203.0.113.1 -> 目标 IP：8.8.8.8
```

3. **外部设备响应**：

外部设备 8.8.8.8 接收到数据包，并将响应数据包发送回 203.0.113.1。

```plaintext
源 IP：8.8.8.8 -> 目标 IP：203.0.113.1
```

4. **路由器进行回写**：

路由器接收到响应数据包，查找连接跟踪表，将目标 IP 地址替换回原始内部设备的 IP 地址（192.168.1.10）。

```plaintext
源 IP：8.8.8.8 -> 目标 IP：192.168.1.10
```

5. **内部设备接收响应**：

内部设备 192.168.1.10 接收到响应数据包。

### 连接跟踪条目示例

以下是一个连接跟踪条目的示例，展示了 SNAT 如何跟踪连接：

```plaintext
tcp      6 431997 ESTABLISHED src=192.168.1.10 dst=8.8.8.8 sport=12345 dport=80 src=8.8.8.8 dst=203.0.113.1 sport=80 dport=12345 [ASSURED] mark=0 use=1
```

- `src=192.168.1.10` 和 `dst=8.8.8.8`：原始连接。
- `sport=12345` 和 `dport=80`：原始源端口和目标端口。
- `src=8.8.8.8` 和 `dst=203.0.113.1`：转换后的连接（用于外部网络）。
- `sport=80` 和 `dport=12345`：转换后的源端口和目标端口。

通过连接跟踪表，路由器可以正确地将响应数据包映射回原始内部设备，实现完整的双向通信。