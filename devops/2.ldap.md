# gerrit
* prepare certificates, please refer to [generate cert](./1-cert.md)
* start ldap container with [ldap.yaml](./compose/ldap.yml)
* open `https://10.10.9.29:8443`, input `Login DN` with `cn=admin,dc=capital,dc=com`, password `zhu88jie`
* create new user in ldap, you can use it to login gerrit, gitlab...
* create `ou=people,dc=capital,dc=com`
    ```
    # LDIF file for adding ou=people under dc=capital,dc=com

    dn: ou=people,dc=capital,dc=com
    objectClass: organizationalUnit
    ou: people
    description: Organizational Unit for people
    ```
* create user
    ```
    # LDIF Export for cn=hanhzf,ou=people,dc=capital,dc=com
    # Server: openldap (openldap)
    # Search Scope: base
    # Search Filter: (objectClass=*)
    # Total Entries: 1
    #
    # Generated by phpLDAPadmin (http://phpldapadmin.sourceforge.net) on August 8, 2024 4:45 pm
    # Version: 1.2.5

    version: 1

    # Entry 1: cn=hanhzf,ou=people,dc=capital,dc=com
    dn: cn=hanhzf,ou=people,dc=capital,dc=com
    cn: hanhzf
    givenname: zhao
    mail: mymail@126.com
    objectclass: inetOrgPerson
    objectclass: top
    sn: han
    uid: hanhzf
    userpassword: {MD5}wb68DeX0CyENafzUADNn9A==
    ```

# 如何配置ldap账号的权限

## 1. 确认数据库用的是哪个db：
```
ldapsearch -Y EXTERNAL -H ldapi:/// -b cn=config -LLL '(objectClass=olcDatabaseConfig)' dn

dn: olcDatabase={-1}frontend,cn=config

dn: olcDatabase={0}config,cn=config

dn: olcDatabase={1}mdb,cn=config
```


## 2. 添加管理和制度账号
```
dn: olcDatabase={1}mdb,cn=config
changetype: modify
replace: olcAccess
olcAccess: to *
  by dn.exact="cn=admin,dc=capital,dc=com" manage
  by dn.exact="cn=readonly,dc=capital,dc=com" read
  by self write
  by anonymous auth
  by * none
```

> 配置解释

1. `by self write`

这条规则允许用户修改自己的条目。

- "self" 指的是当前被访问的条目的所有者。
- "write" 权限允许修改操作。

例如，如果一个用户尝试更新自己的密码或个人信息，这条规则会允许такое的操作。这对于允许用户管理自己的账户信息很有用。

2. `by anonymous auth`

这条规则允许匿名用户进行身份验证操作。

- "anonymous" 指的是还没有通过身份验证的连接。
- "auth" 权限只允许执行绑定（bind）操作，用于身份验证。

这个规则通常用于允许用户或应用程序在提供完整凭证之前先进行初始连接和身份验证。比如，允许登录屏幕的初始连接。

3. `by * none`

如我们之前讨论的，这是一个"兜底"规则。

- "*" 匹配所有其他未在之前规则中明确指定的用户或实体。
- "none" 表示不允许任何访问。

这条规则确保除了之前明确允许的操作外，所有其他的访问尝试都会被拒绝。

这三条规则组合在一起的效果是：

1. 用户可以修改自己的信息。
2. 允许初始的匿名身份验证连接。
3. 除此之外的所有其他访问都被拒绝。

这种配置在安全性和功能性之间取得了平衡：它允许必要的操作（自我管理和初始身份验证），同时仍然保持了对其他访问的严格控制。

需要注意的是，这些规则的顺序很重要。LDAP会按照从上到下的顺序评估这些规则，并使用第一个匹配的规则。因此，更具体或更宽松的规则应该放在更通用或更严格的规则之前。

如果您需要针对特定的使用场景调整这些规则，我们可以进一步讨论如何修改它们以满足您的需求。

## 3. 通过以下命令添加：

```
ldapmodify -Y EXTERNAL -H ldapi:/// -f readonly.ldif
```

## 4. 确认命令执行结果：
```
ldapsearch -x -D "cn=readonly,dc=capital,dc=com" -W -b "ou=people,dc=capital,dc=com" "(objectClass=*)"
```