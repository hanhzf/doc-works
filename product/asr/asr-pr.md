# ASR 项目完整文档

## 目录
1. [用户交互需求](#1-用户交互需求)
2. [系统方案设计](#2-系统方案设计)
3. [基础架构需求](#3-基础架构需求)

## 1. 用户交互需求

### 需求描述
设计一个响应式的H5网页界面，支持语音输入和结果显示。包括自适应布局、语音录制功能、结果展示、错误处理等。

### 详细要求

1. **页面布局和设计**:
   - 整体为一个聊天框界面
   - 支持电脑端和手机端的自适应布局
   - 整体配色以天蓝色为主
   - 对话框底色使用淡色（如白色或其他舒适的色系）
   - 确保字体显示舒适

2. **语音输入功能**:
   - 在屏幕最下方放置一个语音按钮
   - 按钮上显示一个录音小图标
   - 用户按下按钮时开始采集语音，图标变化以指示录音状态

3. **语音录制逻辑**:
   - 语音最长录制时间为60秒
   - 如果用户在55秒内松开按钮，自动上传语音
   - 如果录音达到55秒，显示5秒倒计时提示
   - 60秒时自动结束录音并上传

4. **识别结果显示**:
   - 语音上传后显示"语音识别中"提示
   - 识别结果按时间顺序从上到下显示
   - 当结果超过屏幕显示范围时，出现滚动条
   - 用户可通过滚动查看历史消息

5. **错误处理**:
   - 出错时在上一条消息下方显示错误提示
   - 错误信息使用较小字体和灰色显示
   - 错误提示内容："语音识别错误，请联系管理员"

6. **交互反馈**:
   - 按钮按下状态有明显视觉反馈
   - 录音过程中有适当的视觉指示
   - 语音识别过程中显示加载动画

7. **性能考虑**:
   - 确保页面加载速度快
   - 优化大量消息显示时的性能

8. **辅助功能**:
   - 考虑添加清除对话历史的功能
   - 可能的话，添加文字大小调节功能

## 2. 系统方案设计

### 系统架构图 (ASCII 版本)

```
+-------------+        +----------------+        +-------------------+
|   Frontend  |  <---> |  Backend       |  <---> |  Third-party      |
| (React+TS)  |        |  Service (Py)  |        |  ASR Service      |
+-------------+        +----------------+        +-------------------+
      ^                     ^      ^
      |                     |      |
      |                     |      |
      v                     v      v
+------------------+    +-------------------+
|  WebSocket       |    |  Third-party      |
|  Service         |    |  Auth Service     |
+------------------+    +-------------------+

           +--------------------------------+
           |      Containerized Deployment  |
           |      Cluster Environment       |
           +--------------------------------+
```

### 架构说明

1. **前端（Frontend）**:
   - 使用React和TypeScript开发
   - 实现响应式H5界面，支持语音录制和结果显示

2. **后端服务（Backend Service）**:
   - 使用Python开发
   - 处理文件上传、ASR集成和YAML配置

3. **WebSocket服务**:
   - 独立服务，支持实时通信
   - 实现集群部署和JWT认证

4. **第三方ASR服务**:
   - 外部服务，需要集成
   - 提供核心的语音识别功能

5. **第三方身份认证服务**:
   - 外部服务，需要集成
   - 提供JWT token认证

6. **容器化部署**:
   - 所有内部服务（前端、后端、WebSocket）支持容器化
   - 设计支持集群环境部署

### 系统流程

1. 用户通过前端界面录制语音
2. 前端将语音文件上传至后端服务
3. 后端服务将音频发送给第三方ASR服务进行处理
4. ASR服务返回识别结果给后端服务
5. 后端服务通过WebSocket服务将结果推送给前端
6. 前端实时显示识别结果

### 关键技术点

- 使用WebSocket实现实时通信
- 采用JWT进行身份认证
- 实现非流式ASR处理以提高准确性
- 采用容器化部署以提高系统可扩展性和可维护性

## 3. 基础架构需求

### 3.1 准确性优先的语音识别结果

**概述**: 实现高准确度的语音识别功能，优先考虑结果的准确性而非实时性。

**详细要求**:
1. 使用ASR服务的非流式模式，等待整个音频文件处理完成后才返回结果。
2. 配置ASR请求参数 `result_type` 为 "single"。
3. 简化后端处理逻辑，只需处理一个最终结果。
4. 在前端添加适当的加载提示，以改善用户体验。
5. 实现错误处理机制，应对可能的长时间处理和网络问题。

### 3.2 使用WebSocket进行前后端通信

**概述**: 实现基于WebSocket的实时通信系统，包括独立的WebSocket服务、身份认证集成和集群部署支持。

**详细要求**:
1. 后端服务器实现WebSocket服务，能够维护持久连接。
2. 前端通过HTTP上传语音文件到后端服务器。
3. 上传完成后，前端建立WebSocket连接。
4. 后端服务器通过WebSocket向前端推送语音处理的进度和最终结果。
5. 后端服务器需要能够管理和维护多个WebSocket连接。
6. 实现错误处理和重连机制，确保通信的可靠性。
7. 将WebSocket服务设计为独立服务，与主后端服务分离。
8. 后端服务（ASR处理服务）作为消息发送方，向WebSocket服务推送消息。
9. 前端仅作为消息接收方，从WebSocket服务接收消息。
10. 支持基于主题的消息订阅,允许向特定主题发布消息, 实时消息推送给订阅者
11. 集成现有的基于JWT token的身份管理系统(SSO服务)进行身份认证。
12. 实现安全的WebSocket连接建立过程，包括token验证。
13. 设计并实现后端服务到WebSocket服务的消息推送机制。
14. 增强WebSocket服务的连接管理、心跳检测和错误处理机制。
15. 确保消息的可靠传递和顺序性。
16. 提供WebSocket服务的横向扩展能力，以支持大量并发连接。
17. 设计WebSocket服务以支持集群部署：
    - 实现无状态设计，便于水平扩展
    - 使用分布式会话管理，确保客户端连接在集群中的任何节点都能被正确处理
    - 实现负载均衡策略，均匀分配连接到集群中的不同节点
    - 考虑使用消息队列或发布/订阅系统来处理节点间的消息同步
    - 设计故障转移机制，确保单个节点故障不会影响整体服务
    - 实现集群节点的动态扩缩容能力，无缝处理节点的增加或移除

### 3.3 文件上传和本地存储

**概述**: 实现语音文件的上传功能，支持格式限制和本地存储，包括存储路径配置和文件管理。

**详细要求**:
1. 后端服务器实现文件上传功能。
2. 限制上传文件的格式，只接受特定的语音文件格式。
3. 上传的语音文件应存储在本地文件系统的指定目录中。
4. 文件存储目录应可通过配置文件进行配置。
5. 实现适当的错误处理，如文件格式不正确、存储空间不足等情况。
6. 考虑文件命名策略，避免文件名冲突。
7. 实现文件清理机制，定期删除不再需要的音频文件。

### 3.4 灵活的YAML配置文件

**概述**: 开发基于YAML的配置系统，支持多种系统参数的灵活配置和未来扩展。

**详细要求**:
1. 使用YAML格式作为配置文件的格式。
2. 配置文件应包含但不限于以下配置项：
   - 支持的语音文件格式列表
   - 允许的最大语音文件时长
   - 定期删除语音文件的时间周期
   - 语音文件存放目录路径
   - ASR服务的Access Key和Access Secret
3. 配置文件结构应设计得易于扩展，以支持未来可能新增的配置项。
4. 实现配置文件的读取和解析功能。
5. 提供配置项的验证机制，确保必要的配置项存在且格式正确。
6. 允许在运行时重新加载配置，无需重启服务。
7. 提供默认配置值，以防某些配置项缺失。
8. 考虑敏感信息（如Access Key和Secret）的安全存储问题。

### 3.5 技术架构和容器化支持

**概述**: 定义项目的技术栈、系统组件和容器化支持。

**详细要求**:
1. 系统组件:
   - 前端应用
   - 后端服务
   - WebSocket服务
   - 第三方ASR（语音识别）服务

2. 前端技术栈:
   - 使用React框架
   - 采用TypeScript语言

3. 后端技术栈:
   - 使用Python语言实现后端服务

4. WebSocket服务:
   - 独立的WebSocket服务（可以用Python或其他适合的语言实现）

5. 容器化支持:
   - 确保前端服务、后端服务和WebSocket服务的代码结构和配置支持容器化
   - 提供必要的配置文件（如Dockerfile）以便轻松构建容器镜像
   - 确保应用配置可通过环境变量或外部配置文件注入，以适应容器化环境
   - 考虑日志输出到标准输出流，便于容器化环境中的日志收集
   - 设计健康检查接口，支持容器编排系统的服务健康监控

6. 系统集成:
   - 确保各组件之间的有效通信和集成
   - 实现前端与后端的API交互
   - 实现后端与WebSocket服务的消息传递
   - 集成第三方ASR服务的API调用

7. 开发环境:
   - 为前端和后端设置适当的开发环境
   - 配置TypeScript编译器和React开发工具
   - 设置Python开发环境和必要的依赖管理

8. 测试策略:
   - 为每个组件制定单元测试计划
   - 考虑端到端测试以验证整个系统的功能

